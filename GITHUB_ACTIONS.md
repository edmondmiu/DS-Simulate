# GitHub Actions CI/CD Workflow

## Overview

The `update-tokens.yml` workflow automatically maintains the `tokensource.json` file in sync with changes made to the `tokens/` directory. This ensures the Token Studio integration always has access to the latest design tokens without manual intervention.

## Workflow Configuration

### Trigger
- **Event:** Push to `main` branch
- **Path Filter:** `tokens/**` (only runs when token files change)
- **Prevents:** Infinite loops by NOT triggering on `tokensource.json` changes

### Permissions
- **Required:** `contents: write` (to commit updated tokensource.json)
- **Security:** Minimal permissions principle

### Environment
- **OS:** Ubuntu Latest
- **Node.js:** 20.11.1 (matches development environment)
- **Package Manager:** npm with `npm ci` for reproducible builds

## Workflow Steps

### 1. Repository Setup
- Checkout repository with full history
- Setup Node.js 20.11.1 with npm caching
- Install dependencies using `npm ci`

### 2. Comprehensive Validation
- **TypeScript Compilation:** `npm run build`
- **Code Quality:** `npm run lint` 
- **Test Suite:** `npm test` (11/11 tests must pass)

### 3. Token Consolidation
- Runs `npm run consolidate` to update tokensource.json
- Validates JSON structure and file size
- Counts processed token sets from metadata

### 4. Round-Trip Validation
- Creates backup of tokens directory  
- Runs split â†’ consolidate cycle to verify consistency
- Ensures byte-for-byte accuracy of the pipeline

### 5. Change Detection & Commit
- Checks if tokensource.json actually changed
- Commits with detailed message if changes exist
- Pushes changes back to main branch

### 6. Workflow Summary
- Creates GitHub Step Summary with results
- Reports file size, token count, and validation status
- Provides Token Studio integration URL

## Usage

### Automatic Execution
1. Developer modifies files in `tokens/` directory
2. Commits and pushes changes to `main` branch
3. Workflow automatically triggers and updates `tokensource.json`
4. Token Studio URL immediately serves updated tokens

### Manual Validation
```bash
# Test workflow locally before pushing
npm run validate-workflow

# Expected output: 100% success rate
```

## Integration Details

### Token Studio URL
```
https://raw.githubusercontent.com/edmondmiu/DS-Simulate/main/tokensource.json
```

### Commit Message Format
```
ðŸ¤– Auto-update tokensource.json

- Consolidated from tokens/ directory changes
- File size: 118871 bytes
- Token sets: 7 sets processed
- Validation: All tests passing âœ…
- Round-trip: Verified âœ…

Generated by GitHub Actions workflow
```

### Workflow Status
- **Success:** All validations pass, tokensource.json updated
- **Failure:** Quality gates failed, no changes committed
- **No-op:** No actual changes to tokensource.json needed

## Error Handling

### Validation Failures
- **Tests fail:** Workflow stops, no changes committed
- **Linting errors:** Workflow stops, no changes committed  
- **TypeScript errors:** Workflow stops, no changes committed
- **Round-trip fails:** Workflow stops, tokens directory restored

### Recovery Process
1. Fix validation errors in local development
2. Run `npm run validate-workflow` to test locally
3. Commit and push fixes
4. Workflow will retry automatically

## Security Features

### Infinite Loop Prevention
- Workflow ONLY triggers on `tokens/**` changes
- Does NOT trigger on `tokensource.json` changes
- Conditional logic prevents unnecessary execution

### Permission Management
- Uses minimal `contents: write` permission
- Uses `GITHUB_TOKEN` for authenticated operations
- No external dependencies or secrets required

### Git Configuration
- Automated commits use `action@github.com` identity
- Proper attribution with "GitHub Action" as author
- Clear commit messages for audit trail

## Performance Characteristics

### Typical Execution Time
- **Total:** ~2 minutes for standard token changes
- **Dependencies:** ~30 seconds (with caching)
- **Validation:** ~30 seconds (tests + linting)
- **Consolidation:** ~10 seconds
- **Round-trip:** ~10 seconds
- **Commit:** ~5 seconds

### Optimization Features
- npm caching reduces dependency installation time
- Conditional execution prevents unnecessary work
- Efficient change detection skips commits when not needed

## Monitoring and Troubleshooting

### GitHub UI
- Workflow status visible in Actions tab
- Step-by-step execution logs available
- Workflow summaries show consolidation results

### Local Testing
```bash
# Validate workflow will work
npm run validate-workflow

# Test individual components
npm run build
npm run lint  
npm test
npm run consolidate
```

### Common Issues
1. **Tests failing:** Fix test errors locally first
2. **Linting errors:** Run `npm run lint` and fix issues
3. **TypeScript errors:** Run `npm run build` and fix compilation issues
4. **Permission errors:** Check repository settings for Actions permissions

## Future Enhancements

### Planned Features
- Slack/email notifications for workflow failures
- Performance metrics tracking
- Advanced token validation rules
- Integration with Design System documentation updates

### Epic 3 Integration
- Style Dictionary output generation
- CSS/SCSS file updates
- Multi-format export automation
- Developer consumption pipeline triggers

---

**Generated:** 2025-08-07 by Claude Code  
**Version:** Story 2.3 completion  
**Workflow:** .github/workflows/update-tokens.yml